<!-- Final version of payment.html integrated with Cashfree -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Akshaya Milk Store</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
  <style>
    .price-summary { border-top: 1px solid #e0d5c1; margin-top: 20px; padding-top: 10px; max-width: 500px; margin-left: auto; margin-right: auto; background: #fffdf7; padding: 15px; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05); }
    .price-summary-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 1rem; }
    .price-summary-row.total { font-weight: bold; font-size: 1.1rem; border-top: 1px solid #e0d5c1; margin-top: 10px; padding-top: 10px; color: #5c9c3d; }
  </style>
</head>
<body>
  <nav>
    <h2 class="brand">ðŸ§º AKSHAYA Dairy Product</h2>
    <button onclick="window.location.href='{{ url_for('home') }}'"><i class="fas fa-arrow-left"></i> Back to Store</button>
  </nav>

  <div class="container">
    <h2>Your Order Summary</h2>
    <ul id="cart-items-payment"></ul>
    <div id="price-summary" class="price-summary"></div>

    <div class="customer-details">
      <h3>Customer Information</h3>
      <input type="text" id="customer-name" placeholder="Your Name" required>
      <input type="tel" id="customer-phone" placeholder="Phone Number" required>
      <textarea id="delivery-address" placeholder="Delivery Address" required></textarea>
    </div>

    <div class="payment-section">
<<<<<<< HEAD
      <button id="pay-now-btn" style="background:#6DBE45;color:#fff;font-size:1.1rem;padding:12px 32px;border:none;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(109,190,69,0.13);margin-top:16px;">Pay Now <i class="fas fa-spinner fa-spin" style="display:none;"></i></button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
      const cartList = document.getElementById('cart-items-payment');
      const priceSummary = document.getElementById('price-summary');

      if (cartItems.length === 0) {
        cartList.innerHTML = '<p>Your cart is empty. Please add items from the <a href="{{ url_for("home") }}">store</a>.</p>';
        return;
      }

      let subtotal = 0;
      let taxableSubtotal = 0;

      cartItems.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        if (item.name !== 'Monthly Milk Package') taxableSubtotal += itemTotal;

        const li = document.createElement('li');
        li.className = 'cart-item-payment';
        li.innerHTML = `
          <img src="${item.image}" alt="${item.name}" style="width: 70px; height: 70px;">
          <span>${item.name} Ã— ${item.quantity} = â‚¹${itemTotal}${item.name === 'Monthly Milk Package' ? ' (Fixed price, no tax)' : ''}</span>
          <button onclick="removeItem(${index})">Delete</button>
        `;
        cartList.appendChild(li);
      });

      const gst = taxableSubtotal * 0.12;
      const delivery = taxableSubtotal * 0.08;
      const total = subtotal + gst + delivery;

      priceSummary.innerHTML = `
        <div class="price-summary-row"><span>Subtotal:</span><span>â‚¹${subtotal.toFixed(2)}</span></div>
        <div class="price-summary-row"><span>GST (12%):</span><span>â‚¹${gst.toFixed(2)}</span></div>
        <div class="price-summary-row"><span>Delivery (8%):</span><span>â‚¹${delivery.toFixed(2)}</span></div>
        <div class="price-summary-row total"><span>Total:</span><span>â‚¹${total.toFixed(2)}</span></div>
      `;

      document.getElementById('pay-now-btn').addEventListener('click', async () => {
        const name = document.getElementById('customer-name').value;
        const phone = document.getElementById('customer-phone').value;
        const email = 'guest@example.com';
        const address = document.getElementById('delivery-address').value;

        if (!name || !phone || !address) {
          alert('Please fill in all customer details.');
          return;
        }

        const payNowBtn = document.getElementById('pay-now-btn');
        const spinner = payNowBtn.querySelector('.fa-spinner');

        payNowBtn.disabled = true;
        spinner.style.display = 'inline-block';


        const paymentData = { name, phone, email, address, subtotal, gst, delivery, total, cartItems };

        try {
          const response = await fetch('/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paymentData)
          });

          const result = await response.json();
          if (response.ok && result.paymentSessionId) {
            const cashfree = new Cashfree(result.paymentSessionId);
            cashfree.redirect();
          } else {
            alert(result.message || 'Payment initiation failed.');
          }
        } catch (error) {
          alert('An error occurred. Please try again.');
          console.error(error);
        } finally {
          payNowBtn.disabled = false;
          spinner.style.display = 'none';
        }
      });
    });

    function removeItem(index) {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      window.location.reload();
    }
  </script>
=======
      <h3>Payment</h3>
      <!-- QR code and WhatsApp link removed -->
      <button id="cashfree-pay-btn">Pay Now</button>
    </div>
  </div>

  <div id="toast" class="hidden"></div>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
>>>>>>> 0df262c0ce595e1707a6c09b2a39bad976ad4a64
</body>
</html>